= Lab SQL Subqueries
:stylesheet: boot-darkly.css
:linkcss: boot-darkly.css
:image-url-ironhack: https://user-images.githubusercontent.com/23629340/40541063-a07a0a8a-601a-11e8-91b5-2f13e4e6b441.png
:my-name: Jorge Castro DAPT NOV2021
:description:
:rel-cont: https://github.com/jecastrom/data_3.05_activities.git
//:fn-xxx: Add the explanation foot note here bla bla
:toc:
:toc-title: In this lab, you will be using the Sakila database of movie rentals. Create appropriate joins wherever necessary.
:toc-placement!:
:toclevels: 5
ifdef::env-github[]
:sectnums:
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:experimental:
:table-caption!:
:example-caption!:
:figure-caption!:
:idprefix:
:idseparator: -
:linkattrs:
:fontawesome-ref: http://fortawesome.github.io/Font-Awesome
:icon-inline: {user-ref}/#inline-icons
:icon-attribute: {user-ref}/#size-rotate-and-flip
:video-ref: {user-ref}/#video
:checklist-ref: {user-ref}/#checklists
:list-marker: {user-ref}/#custom-markers
:list-number: {user-ref}/#numbering-styles
:imagesdir-ref: {user-ref}/#imagesdir
:image-attributes: {user-ref}/#put-images-in-their-place
:toc-ref: {user-ref}/#table-of-contents
:para-ref: {user-ref}/#paragraph
:literal-ref: {user-ref}/#literal-text-and-blocks
:admon-ref: {user-ref}/#admonition
:bold-ref: {user-ref}/#bold-and-italic
:quote-ref: {user-ref}/#quotation-marks-and-apostrophes
:sub-ref: {user-ref}/#subscript-and-superscript
:mono-ref: {user-ref}/#monospace
:css-ref: {user-ref}/#custom-styling-with-attributes
:pass-ref: {user-ref}/#passthrough-macros
endif::[]
ifndef::env-github[]
:imagesdir: ./
endif::[]

image::{image-url-ironhack}[width=70]

{my-name}

{rel-cont}[Related content: Activity 3.05]


                                                     
====
''''
====
toc::[]

{description}


= Instructions:

== How many copies of the film Hunchback Impossible exist in the inventory system?

`*_Answer:_*`

```sql
SELECT
    title,
    (
        SELECT
            count(inventory_id) AS num_of_copies
        FROM
            inventory
        WHERE
            film_id IN (
                SELECT
                    film_id
                FROM
                    film
                WHERE
                    title = 'Hunchback Impossible'
            )
    ) AS num_of_copies_available
FROM
    film
WHERE
    title = 'Hunchback Impossible';
```

image::https://user-images.githubusercontent.com/63274055/151388929-7ae54480-08f3-49f1-84d2-8b039b8734f1.png[width=600]



== List all films whose length is longer than the average of all the films.

`*_Answer:_*`

```sql
SELECT
    title AS film_title,
    length AS above_avg_duration
FROM
    film
WHERE
    length > (
        SELECT
            avg(length)
        FROM
            film
    )
ORDER BY
    2 DESC;
```

image::https://user-images.githubusercontent.com/63274055/151395424-c438b1ec-a295-47cd-a108-e348111febf2.png[width=600]



== Use subqueries to display all actors who appear in the film Alone Trip.

`*_Answer:_*`

```sql
SELECT
    a.actor_id,
    concat(a.first_name, ' ', a.last_name) AS actors,
    (
        SELECT
            title
        FROM
            film
        WHERE
            title = 'Alone Trip'
    ) AS film_title
FROM
    film f
    INNER JOIN film_actor fa ON f.film_id = fa.film_id
    INNER JOIN actor a ON fa.actor_id = a.actor_id
WHERE
    title = 'Alone Trip'
GROUP BY
    1;
```

image::https://user-images.githubusercontent.com/63274055/151462706-6444c2a0-0f75-40e6-8a60-a575008578e9.png[width=600]



== Sales have been lagging among young families, and you wish to target all family movies for a promotion. Identify all movies categorized as family films.

`*_Answer:_*`

```sql
SELECT
    title
FROM
    film
WHERE
    film_id IN (
        SELECT
            film_id
        FROM
            film_category
        WHERE
            category_id = (
                SELECT
                    category_id
                FROM
                    category
                WHERE
                    name = 'Family'
            )
    );
```


image::https://user-images.githubusercontent.com/63274055/151557399-3d5c8491-1f96-4958-963f-a497d5b41daa.png[width=600]

[NOTE]
====
Here only using subqueries I can output the expected result: a list of film titles. However, I wanted to add more details so a user can quickly identify what the table is showing. If I wanted to add a column with the name of the category, and category_id for example, it seems to me that the query would become much bigger, having to write more when the same result can be obtained with a join approach.

This is why I combined the subqueries with joins in the next query:
====

`*_Answer:_*`

```sql
SELECT
    c.category_id,
    c.`name` AS category,
    f.film_id,
    f.title AS film_title
FROM
    film f
    INNER JOIN (
        SELECT
            film_id,
            category_id
        FROM
            film_category
    ) fc ON f.film_id = fc.film_id
    INNER JOIN (
        SELECT
            category_id,
            `name`
        FROM
            category
        WHERE
            `name` = 'Family'
    ) c ON fc.category_id = c.category_id;
```

image::https://user-images.githubusercontent.com/63274055/151557176-213b276c-868d-499a-8f60-0dcbacb456cc.png[width=600]




== Get name and email from customers from Canada using subqueries. Do the same with joins. Note that to create a join, you will have to identify the correct tables with their primary keys and foreign keys, that will help you get the relevant information.

== Which are films starred by the most prolific actor? Most prolific actor is defined as the actor that has acted in the most number of films. First you will have to find the most prolific actor and then use that actor_id to find the different films that he/she starred.

== Films rented by most profitable customer. You can use the customer table and payment table to find the most profitable customer ie the customer that has made the largest sum of payments

== Get the client_id and the total_amount_spent of those clients who spent more than the average of the total_amount spent by each client.




====
''''
====


====
''''
====

{rel-cont}[Related content: Activity 3.05]

====
''''
====




xref:Lab-xxxx[Top Section]

xref:Last-section[Bottom section]

//bla bla blafootnote:[{fn-xxx}]


////
.Unordered list title
* gagagagagaga
** gagagatrtrtrzezeze
*** zreu fhjdf hdrfj 
*** hfbvbbvtrtrttrhc
* rtez uezrue rjek  

.Ordered list title
. rwieuzr skjdhf
.. weurthg kjhfdsk skhjdgf
. djhfgsk skjdhfgs 
.. lksjhfgkls ljdfhgkd
... kjhfks sldfkjsdlk




[,sql]
----
----



[NOTE]
====
A sample note admonition.
====
 
TIP: It works!
 
IMPORTANT: Asciidoctor is awesome, don't forget!
 
CAUTION: Don't forget to add the `...-caption` document attributes in the header of the document on GitHub.
 
WARNING: You have no reason not to use Asciidoctor.

bla bla bla the 1NF or first normal form.footnote:[{1nf}]Then wen bla bla


====
- [*] checked
- [x] also checked
- [ ] not checked
-     normal list item
====
[horizontal]
CPU:: The brain of the computer.
Hard drive:: Permanent storage for operating system and/or user files.
RAM:: Temporarily stores information the CPU uses during operation.






bold *constrained* & **un**constrained

italic _constrained_ & __un__constrained

bold italic *_constrained_* & **__un__**constrained

monospace `constrained` & ``un``constrained

monospace bold `*constrained*` & ``**un**``constrained

monospace italic `_constrained_` & ``__un__``constrained

monospace bold italic `*_constrained_*` & ``**__un__**``constrained

////
